"use strict";(self["webpackChunkweb"]=self["webpackChunkweb"]||[]).push([[853],{7853:function(e,a,l){l.r(a),l.d(a,{default:function(){return V}});var t=l(6768),o=l(4232),s=l(5130);const n={class:"order-train"},i={class:"order-train-main"},d={class:"order-train-main"},r={class:"order-train-main"},c={class:"order-train-main"},u=(0,t.Lk)("span",{class:"order-train-main"},"——",-1),p={class:"order-train-main"},v={class:"order-train-main"},k={class:"order-train-ticket"},g={class:"order-train-ticket-main"},f={class:"order-train-ticket-main"},h=(0,t.Lk)("b",null,"勾选要购票的乘客：",-1),b={class:"order-tickets"},C={key:0},m={class:"order-tickets"},_={key:0},y={key:0},T=(0,t.Lk)("br",null,null,-1),E={key:1,style:{color:"red"}},F=(0,t.Lk)("div",null,"12306规则：只有全部是一等座或全部是二等座才支持选座",-1),W=(0,t.Lk)("div",null,"12306规则：余票小于一定数量时，不允许选座（本项目以20为例）",-1),A={key:2,style:{"text-align":"center"}},I={key:0},R={style:{color:"#999999"}},L=(0,t.Lk)("p",{style:{"text-align":"center","font-weight":"bold","font-size":"18px"}},[(0,t.eW)(" 使用服务端验证码削弱瞬时高峰"),(0,t.Lk)("br"),(0,t.eW)(" 防止机器人刷票 ")],-1),S=["src"],w=(0,t.Lk)("p",{style:{"text-align":"center","font-weight":"bold","font-size":"18px"}},[(0,t.eW)(" 使用纯前端验证码削弱瞬时高峰"),(0,t.Lk)("br"),(0,t.eW)(" 减小后端验证码接口的压力 ")],-1),K={class:"book-line"};function X(e,a,l,X,O,x){const M=(0,t.g2)("a-divider"),U=(0,t.g2)("a-checkbox-group"),Y=(0,t.g2)("a-col"),P=(0,t.g2)("a-row"),V=(0,t.g2)("a-select-option"),N=(0,t.g2)("a-select"),G=(0,t.g2)("a-button"),Q=(0,t.g2)("a-switch"),j=(0,t.g2)("a-modal"),D=(0,t.g2)("a-input"),B=(0,t.g2)("loading-outlined");return(0,t.uX)(),(0,t.CE)(t.FK,null,[(0,t.Lk)("div",n,[(0,t.Lk)("span",i,(0,o.v_)(e.dailyTrainTicket.date),1),(0,t.eW)("  "),(0,t.Lk)("span",d,(0,o.v_)(e.dailyTrainTicket.trainCode),1),(0,t.eW)("次  "),(0,t.Lk)("span",r,(0,o.v_)(e.dailyTrainTicket.start),1),(0,t.eW)("站 "),(0,t.Lk)("span",c,"("+(0,o.v_)(e.dailyTrainTicket.startTime)+")",1),(0,t.eW)("  "),u,(0,t.eW)("  "),(0,t.Lk)("span",p,(0,o.v_)(e.dailyTrainTicket.end),1),(0,t.eW)("站 "),(0,t.Lk)("span",v,"("+(0,o.v_)(e.dailyTrainTicket.endTime)+")",1),(0,t.eW)("  "),(0,t.Lk)("div",k,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.seatTypes,(e=>((0,t.uX)(),(0,t.CE)("span",{key:e.type},[(0,t.Lk)("span",null,(0,o.v_)(e.desc),1),(0,t.eW)("： "),(0,t.Lk)("span",g,(0,o.v_)(e.price)+"￥",1),(0,t.eW)("  "),(0,t.Lk)("span",f,(0,o.v_)(e.count),1),(0,t.eW)(" 张票             ")])))),128))])]),(0,t.bF)(M),h,(0,t.eW)("  "),(0,t.bF)(U,{value:e.passengerChecks,"onUpdate:value":a[0]||(a[0]=a=>e.passengerChecks=a),options:e.passengerOptions},null,8,["value","options"]),(0,t.Lk)("div",b,[e.tickets.length>0?((0,t.uX)(),(0,t.Wv)(P,{key:0,class:"order-tickets-header"},{default:(0,t.k6)((()=>[(0,t.bF)(Y,{span:2},{default:(0,t.k6)((()=>[(0,t.eW)("乘客")])),_:1}),(0,t.bF)(Y,{span:6},{default:(0,t.k6)((()=>[(0,t.eW)("身份证")])),_:1}),(0,t.bF)(Y,{span:4},{default:(0,t.k6)((()=>[(0,t.eW)("票种")])),_:1}),(0,t.bF)(Y,{span:4},{default:(0,t.k6)((()=>[(0,t.eW)("座位类型")])),_:1})])),_:1})):(0,t.Q3)("",!0),((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.tickets,(a=>((0,t.uX)(),(0,t.Wv)(P,{class:"order-tickets-row",key:a.passengerId},{default:(0,t.k6)((()=>[(0,t.bF)(Y,{span:2},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(a.passengerName),1)])),_:2},1024),(0,t.bF)(Y,{span:6},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(a.passengerIdCard),1)])),_:2},1024),(0,t.bF)(Y,{span:4},{default:(0,t.k6)((()=>[(0,t.bF)(N,{value:a.passengerType,"onUpdate:value":e=>a.passengerType=e,style:{width:"100%"}},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.PASSENGER_TYPE_ARRAY,(e=>((0,t.uX)(),(0,t.Wv)(V,{key:e.code,value:e.code},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(e.desc),1)])),_:2},1032,["value"])))),128))])),_:2},1032,["value","onUpdate:value"])])),_:2},1024),(0,t.bF)(Y,{span:4},{default:(0,t.k6)((()=>[(0,t.bF)(N,{value:a.seatTypeCode,"onUpdate:value":e=>a.seatTypeCode=e,style:{width:"100%"}},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.seatTypes,(e=>((0,t.uX)(),(0,t.Wv)(V,{key:e.code,value:e.code},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(e.desc),1)])),_:2},1032,["value"])))),128))])),_:2},1032,["value","onUpdate:value"])])),_:2},1024)])),_:2},1024)))),128))]),e.tickets.length>0?((0,t.uX)(),(0,t.CE)("div",C,[(0,t.bF)(G,{type:"primary",size:"large",onClick:e.finishCheckPassenger},{default:(0,t.k6)((()=>[(0,t.eW)("提交订单")])),_:1},8,["onClick"])])):(0,t.Q3)("",!0),(0,t.bF)(j,{visible:e.visible,"onUpdate:visible":a[1]||(a[1]=a=>e.visible=a),title:"请核对以下信息",style:{top:"50px",width:"800px"},"ok-text":"确认","cancel-text":"取消",onOk:e.showFirstImageCodeModal},{default:(0,t.k6)((()=>[(0,t.Lk)("div",m,[e.tickets.length>0?((0,t.uX)(),(0,t.Wv)(P,{key:0,class:"order-tickets-header"},{default:(0,t.k6)((()=>[(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[(0,t.eW)("乘客")])),_:1}),(0,t.bF)(Y,{span:15},{default:(0,t.k6)((()=>[(0,t.eW)("身份证")])),_:1}),(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[(0,t.eW)("票种")])),_:1}),(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[(0,t.eW)("座位类型")])),_:1})])),_:1})):(0,t.Q3)("",!0),((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.tickets,(a=>((0,t.uX)(),(0,t.Wv)(P,{class:"order-tickets-row",key:a.passengerId},{default:(0,t.k6)((()=>[(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(a.passengerName),1)])),_:2},1024),(0,t.bF)(Y,{span:15},{default:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(a.passengerIdCard),1)])),_:2},1024),(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.PASSENGER_TYPE_ARRAY,(e=>((0,t.uX)(),(0,t.CE)("span",{key:e.code},[e.code===a.passengerType?((0,t.uX)(),(0,t.CE)("span",_,(0,o.v_)(e.desc),1)):(0,t.Q3)("",!0)])))),128))])),_:2},1024),(0,t.bF)(Y,{span:3},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.seatTypes,(e=>((0,t.uX)(),(0,t.CE)("span",{key:e.code},[e.code===a.seatTypeCode?((0,t.uX)(),(0,t.CE)("span",y,(0,o.v_)(e.desc),1)):(0,t.Q3)("",!0)])))),128))])),_:2},1024)])),_:2},1024)))),128)),T,0===e.chooseSeatType?((0,t.uX)(),(0,t.CE)("div",E,[(0,t.eW)(" 您购买的车票不支持选座 "),F,W])):((0,t.uX)(),(0,t.CE)("div",A,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.SEAT_COL_ARRAY,(a=>((0,t.uX)(),(0,t.Wv)(Q,{class:"choose-seat-item",key:a.code,checked:e.chooseSeatObj[a.code+"1"],"onUpdate:checked":l=>e.chooseSeatObj[a.code+"1"]=l,"checked-children":a.desc,"un-checked-children":a.desc},null,8,["checked","onUpdate:checked","checked-children","un-checked-children"])))),128)),e.tickets.length>1?((0,t.uX)(),(0,t.CE)("div",I,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(e.SEAT_COL_ARRAY,(a=>((0,t.uX)(),(0,t.Wv)(Q,{class:"choose-seat-item",key:a.code,checked:e.chooseSeatObj[a.code+"2"],"onUpdate:checked":l=>e.chooseSeatObj[a.code+"2"]=l,"checked-children":a.desc,"un-checked-children":a.desc},null,8,["checked","onUpdate:checked","checked-children","un-checked-children"])))),128))])):(0,t.Q3)("",!0),(0,t.Lk)("div",R,"提示：您可以选择"+(0,o.v_)(e.tickets.length)+"个座位",1)]))])])),_:1},8,["visible","onOk"]),(0,t.bF)(j,{visible:e.imageCodeModalVisible,"onUpdate:visible":a[4]||(a[4]=a=>e.imageCodeModalVisible=a),title:null,footer:null,closable:!1,style:{top:"50px",width:"400px"}},{default:(0,t.k6)((()=>[L,(0,t.Lk)("p",null,[(0,t.bF)(D,{value:e.imageCode,"onUpdate:value":a[3]||(a[3]=a=>e.imageCode=a),placeholder:"图片验证码"},{suffix:(0,t.k6)((()=>[(0,t.bo)((0,t.Lk)("img",{src:e.imageCodeSrc,alt:"验证码",onClick:a[2]||(a[2]=a=>e.loadImageCode())},null,8,S),[[s.aG,!!e.imageCodeSrc]])])),_:1},8,["value"])]),(0,t.bF)(G,{type:"danger",block:"",onClick:e.handleOk},{default:(0,t.k6)((()=>[(0,t.eW)("输入验证码后开始购票")])),_:1},8,["onClick"])])),_:1},8,["visible"]),(0,t.bF)(j,{visible:e.firstImageCodeModalVisible,"onUpdate:visible":a[6]||(a[6]=a=>e.firstImageCodeModalVisible=a),title:null,footer:null,closable:!1,style:{top:"50px",width:"400px"}},{default:(0,t.k6)((()=>[w,(0,t.Lk)("p",null,[(0,t.bF)(D,{value:e.firstImageCodeTarget,"onUpdate:value":a[5]||(a[5]=a=>e.firstImageCodeTarget=a),placeholder:"验证码"},{suffix:(0,t.k6)((()=>[(0,t.eW)((0,o.v_)(e.firstImageCodeSourceA)+" + "+(0,o.v_)(e.firstImageCodeSourceB),1)])),_:1},8,["value"])]),(0,t.bF)(G,{type:"danger",block:"",onClick:e.validFirstImageCode},{default:(0,t.k6)((()=>[(0,t.eW)("提交验证码")])),_:1},8,["onClick"])])),_:1},8,["visible"]),(0,t.bF)(j,{visible:e.lineModalVisible,"onUpdate:visible":a[7]||(a[7]=a=>e.lineModalVisible=a),title:"排队购票",footer:null,maskClosable:!1,closable:!1,style:{top:"50px",width:"400px"}},{default:(0,t.k6)((()=>[(0,t.Lk)("div",K,[(0,t.bo)((0,t.Lk)("div",null,[(0,t.bF)(B),(0,t.eW)(" 系统正在处理中... ")],512),[[s.aG,e.confirmOrderLineCount<0]]),(0,t.bo)((0,t.Lk)("div",null,[(0,t.bF)(B),(0,t.eW)(" 您前面还有"+(0,o.v_)(e.confirmOrderLineCount)+"位用户在购票，排队中，请稍候 ",1)],512),[[s.aG,e.confirmOrderLineCount>=0]])])])),_:1},8,["visible"])],64)}l(4114);var O=l(144),x=l(8355),M=l(5108),U=(0,t.pM)({name:"order-view",setup(){const e=(0,O.KR)([]),a=(0,O.KR)([]),l=(0,O.KR)([]),o=SessionStorage.get(SESSION_ORDER)||{};console.log("下单的车次信息",o);const s=window.SEAT_TYPE;console.log(s);const n=[];for(let t in s){let e=t.toLowerCase();o[e]>=0&&n.push({type:t,code:s[t]["code"],desc:s[t]["desc"],count:o[e],price:o[e+"Price"]})}console.log("本车次提供的座位：",n);const i=(0,O.KR)([]),d=window.PASSENGER_TYPE_ARRAY,r=(0,O.KR)(!1),c=(0,O.KR)(!1),u=(0,O.KR)(),p=(0,O.KR)(-1);(0,t.wB)((()=>l.value),((e,a)=>{console.log("勾选乘客发生变化",e,a),i.value=[],l.value.forEach((e=>i.value.push({passengerId:e.id,passengerType:e.type,seatTypeCode:n[0].code,passengerName:e.name,passengerIdCard:e.idCard})))}),{immediate:!0});const v=(0,O.KR)(0),k=(0,t.EW)((()=>window.SEAT_COL_ARRAY.filter((e=>e.type===v.value)))),g=(0,O.KR)({});(0,t.wB)((()=>k.value),(()=>{g.value={};for(let e=1;e<=2;e++)k.value.forEach((a=>{g.value[a.code+e]=!1}));console.log("初始化两排座位，都是未选中：",g.value)}),{immediate:!0});const f=()=>{x.A.get("/member/passenger/query-mine").then((l=>{let t=l.data;t.success?(e.value=t.content,e.value.forEach((e=>a.value.push({label:e.name,value:e})))):M.A.error({description:t.message})}))},h=()=>{if(console.log("购票列表：",i.value),i.value.length>5)return void M.A.error({description:"最多只能购买5张车票"});let e=Tool.copy(n);for(let t=0;t<i.value.length;t++){let a=i.value[t];for(let l=0;l<e.length;l++){let t=e[l];if(a.seatTypeCode===t.code&&(t.count--,t.count<0))return void M.A.error({description:t.desc+"余票不足"})}}console.log("前端余票校验通过");let a=[];for(let t=0;t<i.value.length;t++){let e=i.value[t];a.push(e.seatTypeCode)}const l=Array.from(new Set(a));if(console.log("选好的座位类型：",l),1!==l.length)console.log("选了多种座位，不支持选座"),v.value=0;else if(l[0]===s.YDZ.code?(console.log("一等座选座"),v.value=s.YDZ.code):l[0]===s.EDZ.code?(console.log("二等座选座"),v.value=s.EDZ.code):(console.log("不是一等座或二等座，不支持选座"),v.value=0),0!==v.value)for(let t=0;t<n.length;t++){let e=n[t];if(l[0]===e.code&&e.count<20){console.log("余票小于20张就不支持选座"),v.value=0;break}}r.value=!0},b=()=>{if(Tool.isEmpty(E.value))return void M.A.error({description:"验证码不能为空"});console.log("选好的座位：",g.value);for(let a=0;a<i.value.length;a++)i.value[a].seat=null;let e=-1;for(let a in g.value)if(g.value[a]){if(e++,e>i.value.length-1)return void M.A.error({description:"所选座位数大于购票数"});i.value[e].seat=a}e>-1&&e<i.value.length-1?M.A.error({description:"所选座位数小于购票数"}):(console.log("最终购票：",i.value),x.A.post("/business/confirm-order/do",{dailyTrainTicketId:o.id,date:o.date,trainCode:o.trainCode,start:o.start,end:o.end,tickets:i.value,imageCodeToken:y.value,imageCode:E.value}).then((e=>{let a=e.data;a.success?(r.value=!1,_.value=!1,c.value=!0,u.value=a.content,m()):M.A.error({description:a.message})})))};let C;const m=()=>{p.value=-1,C=setInterval((function(){x.A.get("/business/confirm-order/query-line-count/"+u.value).then((e=>{let a=e.data;if(a.success){let e=a.content;switch(e){case-1:M.A.success({description:"购票成功！"}),c.value=!1,clearInterval(C);break;case-2:M.A.error({description:"购票失败！"}),c.value=!1,clearInterval(C);break;case-3:M.A.error({description:"抱歉，没票了！"}),c.value=!1,clearInterval(C);break;default:p.value=e}}else M.A.error({description:a.message})}))}),500)},_=(0,O.KR)(),y=(0,O.KR)(),T=(0,O.KR)(),E=(0,O.KR)(),F=()=>{y.value=Tool.uuid(8),T.value="http://8.138.89.87:8848/business/kaptcha/image-code/"+y.value},W=()=>{F(),_.value=!0},A=(0,O.KR)(),I=(0,O.KR)(),R=(0,O.KR)(),L=(0,O.KR)(),S=()=>{A.value=Math.floor(10*Math.random()+1)+10,I.value=Math.floor(10*Math.random()+1)+20},w=()=>{S(),L.value=!0},K=()=>{parseInt(R.value)===parseInt(A.value+I.value)?(L.value=!1,W()):M.A.error({description:"验证码错误"})};return(0,t.sV)((()=>{f()})),{passengers:e,dailyTrainTicket:o,seatTypes:n,passengerOptions:a,passengerChecks:l,tickets:i,PASSENGER_TYPE_ARRAY:d,visible:r,finishCheckPassenger:h,chooseSeatType:v,chooseSeatObj:g,SEAT_COL_ARRAY:k,handleOk:b,imageCodeToken:y,imageCodeSrc:T,imageCode:E,showImageCodeModal:W,imageCodeModalVisible:_,loadImageCode:F,firstImageCodeSourceA:A,firstImageCodeSourceB:I,firstImageCodeTarget:R,firstImageCodeModalVisible:L,showFirstImageCodeModal:w,validFirstImageCode:K,lineModalVisible:c,confirmOrderId:u,confirmOrderLineCount:p}}}),Y=l(1241);const P=(0,Y.A)(U,[["render",X]]);var V=P}}]);
//# sourceMappingURL=853.31cc6ac4.js.map